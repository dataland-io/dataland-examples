## Single source of truth to declare new functions (aka workers) + tables
moduleId: join-stripe-postgres-demo-example

buildCommand: npm run build

parameters:
  - stripe-api-key

info:
  title: Custom Order Refund Workflow
  description: Issue refunds to high LTV customers
  author: Acme Corp

workers:
  # Worker to handle the join every 30 seconds
  - workerId: join-stripe-mysql-demo
    scriptPath: dist/joinStripeMySQLDemo.bundle.js
    triggers:
      cron:
        cronExpression: "*/15 * * * * * *"

  # Worker to handle the Stripe credit on button click
  - workerId: post-stripe-credit
    scriptPath: dist/postStripeCredit.bundle.js
    env:
      STRIPE_API_KEY: stripe-api-key
    triggers:
      transaction: {}

tables:
  - tableName: "orders_credit_workflow"
    autoMigrate: true
    columnDescriptors:
      # id
      - columnName: "order_id"
        dataType: float64
        columnAnnotations:
          dataland.io/column-width: "120"

      # customer_id
      - columnName: "customer_id"
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "120"

      # delivery-status
      - columnName: "delivery_status"
        dataType: string
        columnAnnotations:
          dataland.io/column-display-config: |
            {
              "type": "select",
              "options": [
                {
                  "value": "Unable to get delivered",
                  "theme": "ruby"
                },
                {
                  "value": "In warehouse",
                  "theme": "orange"
                },
                {
                  "value": "In transit",
                  "theme": "yellow"
                },
                {
                  "value": "Delivered",
                  "theme": "green"
                }
              ]
            }

      # order_placed_at
      - columnName: "order_placed_at"
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "180"

      # delivery_time
      - columnName: "delivery_time_mins"
        dataType: float64
        columnAnnotations:
          dataland.io/column-width: "120"

      # rating
      - columnName: "user_rating"
        dataType: float64
        columnAnnotations:
          dataland.io/column-width: "120"

      # user_rating_comment
      - columnName: "user_rating_comment"
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "180"

      # order_value
      - columnName: "order_value"
        dataType: float64
        columnAnnotations:
          dataland.io/column-width: "120"

      - columnName: phone
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "150"

      - columnName: email
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "150"

      - columnName: name
        dataType: string
        columnAnnotations:
          dataland.io/column-width: "150"

      - columnName: lifetime_order_value
        dataType: float64
        columnAnnotations:
          dataland.io/column-width: "150"

      - columnName: stripe_url
        dataType: string
        columnAnnotations:
          dataland.io/column-display-config: |
            {
              "type": "url"
            }

      - columnName: "stripe_customer_id"
        dataType: string

      - columnName: "issue_credit"
        dataType: int32
        columnAnnotations:
          dataland.io/column-display-config: |
            {
              "type": "button",
              "label": "Issue $25 credit",
              "theme": "blue"
            }

      - columnName: "credit_processed_at"
        dataType: string

      - columnName: "send_email"
        dataType: int32
        columnAnnotations:
          dataland.io/column-display-config: |
            {
              "type": "button",
              "label": "Send notification email",
              "theme": "blue"
            }

      - columnName: "email_sent_at"
        dataType: string
